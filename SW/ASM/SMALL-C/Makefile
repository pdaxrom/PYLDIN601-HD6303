VM = ./scvm

all: smallc as03 UNICC.CMD UNIAS.CMD

CFLAGS = -O2

scvm: scvm.o
	$(CC) -o $@ $^

SMALLCX.CMD: scvm NATIVE/SMALLCX.C
	$(VM) BOOTSTRAP/SMALLC.CMD -o SMALLCX.ASM NATIVE/SMALLCX.C
	$(VM) BOOTSTRAP/AS03.CMD -o SMALLCX.CMD SMALLCX.ASM

AS03X.CMD: scvm AS03/AS03.C SMALLCX.CMD
	cd AS03 && ../$(VM) ../SMALLCX.CMD -o ../AS03X.ASM AS03.C
	$(VM) BOOTSTRAP/AS03.CMD -o AS03X.CMD AS03X.ASM

SMALLC.CMD: scvm NATIVE/SMALLCX.C SMALLCX.CMD AS03X.CMD
	$(VM) SMALLCX.CMD -o SMALLC.ASM NATIVE/SMALLCX.C
	$(VM) AS03X.CMD -o SMALLC.CMD SMALLC.ASM

AS03.CMD: scvm AS03/AS03.C AS03X.CMD SMALLC.CMD
	cd AS03 && ../$(VM) ../SMALLC.CMD -o ../AS03.ASM AS03.C
	$(VM) AS03X.CMD -o AS03.CMD AS03.ASM

smallc: scvm.c smallc.h
	$(CC) -o $@ scvm.c -DAPP=\"smallc.h\" -Wall $(CFLAGS)

smallc.h: SMALLC.CMD
	hexdump -v -e '"\t" 16/1 "0x%02x, " "\n"' $^ | sed 's/0x  ,//g' > $@

as03: scvm.c as03.h
	$(CC) -o $@ scvm.c -DAPP=\"as03.h\" -Wall $(CFLAGS)

as03.h: AS03.CMD
	hexdump -v -e '"\t" 16/1 "0x%02x, " "\n"' $^ | sed 's/0x  ,//g' > $@

UNIAS.CMD: AS03.CMD CCINT.CMD
	cat CCINT.CMD AS03.CMD > UNIAS.CMD

UNICC.CMD: SMALLC.CMD CCINT.CMD
	$(VM) SMALLC.CMD -o CCTMP.ASM NATIVE/SMALLC.C
	$(VM) AS03.CMD -o CCTMP.CMD CCTMP.ASM
	cat CCINT.CMD CCTMP.CMD > UNICC.CMD

CCINT.CMD: AS03.CMD CCINT.ASM
	$(VM) AS03.CMD -o CCINT.CMD CCINT.ASM

clean:
	rm -f scvm *.o out.sym AS03X.CMD AS03X.ASM SMALLCX.CMD SMALLCX.ASM AS03.CMD AS03.ASM SMALLC.CMD SMALLC.ASM
	rm -f smallc smallc.h
	rm -f as03 as03.h
	rm -f CCTMP.CMD CCTMP.ASM CCINT.CMD
	rm -f UNIAS.CMD UNICC.CMD
